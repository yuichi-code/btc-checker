<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BTC price at a second (aggTrades)</title>
<style>
  :root{--bd:#e5e7eb;--fg:#111827;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:var(--fg);margin:16px;line-height:1.7}
  h1{font-size:1.15rem;margin:0 0 12px}
  .card{border:1px solid var(--bd);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .muted{color:var(--muted)}
  input,button{padding:10px;border-radius:10px;border:1px solid var(--bd)}
  button{background:#f9fafb}
  .small{font-size:.92rem}
  table{border-collapse:collapse;width:100%;margin-top:10px}
  th,td{border:1px solid var(--bd);padding:4px 6px;text-align:center}
</style>
</head>
<body>
  <h1>「その秒のBTC価格（USD）」ピンポイント検索</h1>
  <div class="card">
    <div class="muted small">※ JSTの日時を入力して「検索」。UTCへ変換して <code>aggTrades</code> を叩き、ターゲット秒に最も近い約定を返すで。</div>
    <div class="row">
      <label for="dt" class="small">日時（JST, 秒まで）</label>
      <input id="dt" type="datetime-local" step="1" />
      <label for="sec" class="small">検索幅±秒</label>
      <input id="sec" type="number" min="1" value="30" style="width:100px" />
      <button id="go">検索</button>
    </div>
  </div>

  <div class="card">
    <div class="muted small" id="head">未検索</div>
    <div class="mono" id="main">-</div>
    <div class="mono" id="ctx">-</div>
    <div class="muted small" id="note">Binance REST API / <code>/api/v3/aggTrades</code></div>
  </div>

  <!-- ここから追加：購入記録フォーム -->
  <div class="card">
    <h3>購入記録</h3>
    <div class="row">
      <label class="small">BTCドル価格</label>
      <input id="priceUsd" type="number" step="0.01">
      <label class="small">ドル円（逆算）</label>
      <input id="usdJpy" type="number" step="0.01">
      <label class="small">購入量(BTC)</label>
      <input id="amountBtc" type="number" step="0.00000001">
      <button id="addRecord">記録する</button>
    </div>
    <table id="recordsTable">
      <thead>
        <tr>
          <th>購入日時(JST)</th>
          <th>BTCドル価格</th>
          <th>BTC円価格</th>
          <th>購入量(BTC)</th>
          <th>購入額(円)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- ここまで追加 -->

<script>
  const pad2 = n => String(n).padStart(2,'0');
  const fmtJSTms = (ms)=>{
    const d = new Date(ms + 9*3600*1000); // UTC→JST
    return `${d.getUTCFullYear()}/${pad2(d.getUTCMonth()+1)}/${pad2(d.getUTCDate())} ${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())}.${String(d.getUTCMilliseconds()).padStart(3,'0')}`;
  };
  const fmtNum = (n,d=2)=> Number(n).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});

function jstLocalToUtcMs(str){
  return new Date(str + '+09:00').getTime();
}

  async function fetchAggTrades(symbol, startMs, endMs, limit=1000){
    const url = new URL('https://api.binance.com/api/v3/aggTrades');
    url.search = new URLSearchParams({
      symbol, startTime:String(startMs), endTime:String(endMs), limit:String(limit)
    }).toString();
    const res = await fetch(url);
    if(!res.ok) throw new Error(`aggTrades fetch failed (${res.status})`);
    return res.json(); // [{p:price,q:qty,T:ms,...}]
  }

  function findClosest(trades, targetMs){
    if(!trades || !trades.length) return null;
    let best = trades[0], bestDiff = Math.abs(trades[0].T - targetMs);
    for(const t of trades){
      const d = Math.abs(t.T - targetMs);
      if(d < bestDiff){ best = t; bestDiff = d; }
    }
    let before=null, after=null;
    for(const t of trades){
      if(t.T <= targetMs){ if(!before || t.T > before.T) before = t; }
      if(t.T >= targetMs){ if(!after  || t.T < after.T ) after  = t; }
    }
    return {best, before, after, diffMs: bestDiff};
  }

  async function run(){
    const dtStr = document.getElementById('dt').value;
    const spanSec = Math.max(1, parseInt(document.getElementById('sec').value,10) || 30);
    const head = document.getElementById('head');
    const main = document.getElementById('main');
    const ctx  = document.getElementById('ctx');
    const note = document.getElementById('note');

    if(!dtStr){ head.textContent = '日時が未入力やで'; return; }

    const targetUtcMs = jstLocalToUtcMs(dtStr);

    let windowSec = spanSec;
    let tradesUsd = [], tradesJpy = [];
    head.textContent = `JST ${dtStr.replace('T',' ')} の直近約定を探索中…`;

    // 段階的にウィンドウ拡大（データ薄い時間帯対応）
    for(const _ of [1,2,3]){
      const start = targetUtcMs - windowSec*1000;
      const end   = targetUtcMs + windowSec*1000;
      try{
        // ここから修正：USD と JPY を同一ウィンドウで両取り
        [tradesUsd, tradesJpy] = await Promise.all([
          fetchAggTrades('BTCUSDT', start, end, 1000),
          fetchAggTrades('BTCJPY',  start, end, 1000)
        ]);
        // ここまで修正
      }catch(err){
        note.textContent = `エラー: ${err.message}`;
        return;
      }
      if(tradesUsd.length || tradesJpy.length) break;
      windowSec *= 4;
    }

    if(!tradesUsd.length){
      head.textContent = 'その近辺の約定（BTCUSDT）が無かったで';
      main.textContent = '-';
      ctx.textContent  = '-';
      return;
    }

    const cUsd = findClosest(tradesUsd, targetUtcMs);
    const bestUsd = cUsd.best;

    // ここから追加：BTCJPY も最近傍を取り、USD/JPY を逆算
    if(!tradesJpy.length){
      note.textContent = 'BTCJPYが取れんかったからUSD/JPY逆算はスキップ';
    }
    let usdjpyText = '';
    let usdjpy = null;
    if(tradesJpy.length){
      const cJpy = findClosest(tradesJpy, targetUtcMs);
      const bestJpy = cJpy.best;
      // price は文字列のことがあるので数値化
      const pUsd = parseFloat(bestUsd.p);
      const pJpy = parseFloat(bestJpy.p);
      if(pUsd > 0){
        usdjpy = pJpy / pUsd;
        usdjpyText = `（USD/JPY≈ ${fmtNum(usdjpy,2)} = BTCJPY/BTCUSDT）`;
        // 入力欄へ自動反映
        document.getElementById('priceUsd').value = pUsd.toFixed(2);
        document.getElementById('usdJpy').value  = usdjpy.toFixed(2);
      }
      // 文脈：直前直後もJPY側を見せる
      ctx.textContent  = `USD 直前: ${cUsd.before? fmtJSTms(cUsd.before.T)+' @ '+fmtNum(cUsd.before.p,2): 'なし'} ／ 直後: ${cUsd.after? fmtJSTms(cUsd.after.T)+' @ '+fmtNum(cUsd.after.p,2): 'なし'}
  ｜ JPY 直前: ${cJpy.before? fmtJSTms(cJpy.before.T)+' @ '+fmtNum(cJpy.before.p,0): 'なし'} ／ 直後: ${cJpy.after? fmtJSTms(cJpy.after.T)+' @ '+fmtNum(cJpy.after.p,0): 'なし'}`;
    } else {
      // 既存USD側の文脈だけ
      ctx.textContent  = `直前: ${cUsd.before? fmtJSTms(cUsd.before.T)+' @ '+fmtNum(cUsd.before.p,2): 'なし'} ／ 直後: ${cUsd.after? fmtJSTms(cUsd.after.T)+' @ '+fmtNum(cUsd.after.p,2): 'なし'}`;
    }
    // ここまで追加

    head.textContent = `JST ${dtStr.replace('T',' ')} の直近（差 ${Math.round(cUsd.diffMs)} ms）`;
    main.textContent = `価格(USD): ${fmtNum(bestUsd.p, 2)}   量(BTC): ${bestUsd.q}   約定時刻(JST): ${fmtJSTms(bestUsd.T)} ${usdjpyText}`;
    note.textContent = 'Binance aggTrades（BTCUSDT & BTCJPY）で逆算';
  }

  (function init(){
    const now = new Date();
    const j = new Date(now.getTime() + 9*3600*1000);
    const s = `${j.getUTCFullYear()}-${pad2(j.getUTCMonth()+1)}-${pad2(j.getUTCDate())}T${pad2(j.getUTCHours())}:${pad2(j.getUTCMinutes())}:${pad2(j.getUTCSeconds())}`;
    document.getElementById('dt').value = s;
    document.getElementById('go').addEventListener('click', run);

    // ここから追加：購入記録ボタン処理（円換算は逆算レートで）
    document.getElementById('addRecord').addEventListener('click', ()=>{
      const dt = document.getElementById('dt').value.replace('T',' ');
      const priceUsd = parseFloat(document.getElementById('priceUsd').value);
      const usdJpy   = parseFloat(document.getElementById('usdJpy').value);
      const amount   = parseFloat(document.getElementById('amountBtc').value);
      if(isNaN(priceUsd)||isNaN(usdJpy)||isNaN(amount)) return alert("価格・レート・数量を全部入れてな");

      const priceJpy = priceUsd * usdJpy;
      const totalJpy = priceJpy * amount;

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dt}</td><td>${fmtNum(priceUsd,2)}</td><td>${fmtNum(priceJpy,2)}</td><td>${amount}</td><td>${fmtNum(totalJpy,0)}</td>`;
      document.querySelector('#recordsTable tbody').appendChild(tr);
    });
    // ここまで追加
  })();
</script>
</body>
</html>

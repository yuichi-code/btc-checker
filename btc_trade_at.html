<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BTC price at a second (aggTrades)</title>
<style>
  :root{--bd:#e5e7eb;--fg:#111827;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:var(--fg);margin:16px;line-height:1.7}
  h1{font-size:1.15rem;margin:0 0 12px}
  .card{border:1px solid var(--bd);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .muted{color:var(--muted)}
  input,button{padding:10px;border-radius:10px;border:1px solid var(--bd)}
  button{background:#f9fafb}
  .small{font-size:.92rem}
  table{border-collapse:collapse;width:100%;margin-top:10px}
  th,td{border:1px solid var(--bd);padding:4px 6px;text-align:center}
</style>
</head>
<body>
  <h1>ã€Œãã®ç§’ã®BTCä¾¡æ ¼ï¼ˆUSDï¼‰ã€ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆæ¤œç´¢</h1>
  <div class="card">
    <div class="muted small">â€» JSTã®æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ã€Œæ¤œç´¢ã€ã€‚UTCã¸å¤‰æ›ã—ã¦ <code>aggTrades</code> ã‚’å©ãã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç§’ã«æœ€ã‚‚è¿‘ã„ç´„å®šã‚’è¿”ã™ã§ã€‚</div>
    <div class="row">
      <label for="dt" class="small">æ—¥æ™‚ï¼ˆJST, ç§’ã¾ã§ï¼‰</label>
      <input id="dt" type="datetime-local" step="1" />
      <label for="sec" class="small">æ¤œç´¢å¹…Â±ç§’</label>
      <input id="sec" type="number" min="1" value="30" style="width:100px" />
      <button id="go">æ¤œç´¢</button>
    </div>
  </div>

  <div class="card">
    <div class="muted small" id="head">æœªæ¤œç´¢</div>
    <div class="mono" id="main">-</div>
    <div class="mono" id="ctx">-</div>
    <div class="muted small" id="note">Binance REST API / <code>/api/v3/aggTrades</code></div>
  </div>

  <!-- ã“ã“ã‹ã‚‰è¿½åŠ ï¼šè³¼å…¥è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card">
    <h3>è³¼å…¥è¨˜éŒ²</h3>
    <div class="row">
      <label class="small">BTCãƒ‰ãƒ«ä¾¡æ ¼</label>
      <input id="priceUsd" type="number" step="0.01">
      <label class="small">ãƒ‰ãƒ«å††ï¼ˆé€†ç®—ï¼‰</label>
      <input id="usdJpy" type="number" step="0.01">
      <label class="small">è³¼å…¥é‡(BTC)</label>
      <input id="amountBtc" type="number" step="0.00000001">
      <button id="addRecord">è¨˜éŒ²ã™ã‚‹</button>
    </div>
    <table id="recordsTable">
      <thead>
        <tr>
          <th>è³¼å…¥æ—¥æ™‚(JST)</th>
          <th>BTCãƒ‰ãƒ«ä¾¡æ ¼</th>
          <th>BTCå††ä¾¡æ ¼</th>
          <th>è³¼å…¥é‡(BTC)</th>
          <th>è³¼å…¥é¡(å††)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- ã“ã“ã¾ã§è¿½åŠ  -->

<script>
  const pad2 = n => String(n).padStart(2,'0');
  const fmtJSTms = (ms)=>{
    const d = new Date(ms + 9*3600*1000); // UTCâ†’JST
    return `${d.getUTCFullYear()}/${pad2(d.getUTCMonth()+1)}/${pad2(d.getUTCDate())} ${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())}.${String(d.getUTCMilliseconds()).padStart(3,'0')}`;
  };
  const fmtNum = (n,d=2)=> Number(n).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});

function jstLocalToUtcMs(str){
  return new Date(str + '+09:00').getTime();
}

  async function fetchAggTrades(symbol, startMs, endMs, limit=1000){
    const url = new URL('https://api.binance.com/api/v3/aggTrades');
    url.search = new URLSearchParams({
      symbol, startTime:String(startMs), endTime:String(endMs), limit:String(limit)
    }).toString();
    const res = await fetch(url);
    if(!res.ok) throw new Error(`aggTrades fetch failed (${res.status})`);
    return res.json(); // [{p:price,q:qty,T:ms,...}]
  }

  function findClosest(trades, targetMs){
    if(!trades || !trades.length) return null;
    let best = trades[0], bestDiff = Math.abs(trades[0].T - targetMs);
    for(const t of trades){
      const d = Math.abs(t.T - targetMs);
      if(d < bestDiff){ best = t; bestDiff = d; }
    }
    let before=null, after=null;
    for(const t of trades){
      if(t.T <= targetMs){ if(!before || t.T > before.T) before = t; }
      if(t.T >= targetMs){ if(!after  || t.T < after.T ) after  = t; }
    }
    return {best, before, after, diffMs: bestDiff};
  }

  async function run(){
    const dtStr = document.getElementById('dt').value;
    const spanSec = Math.max(1, parseInt(document.getElementById('sec').value,10) || 30);
    const head = document.getElementById('head');
    const main = document.getElementById('main');
    const ctx  = document.getElementById('ctx');
    const note = document.getElementById('note');

    if(!dtStr){ head.textContent = 'æ—¥æ™‚ãŒæœªå…¥åŠ›ã‚„ã§'; return; }

    const targetUtcMs = jstLocalToUtcMs(dtStr);

    let windowSec = spanSec;
    let tradesUsd = [], tradesJpy = [];
    head.textContent = `JST ${dtStr.replace('T',' ')} ã®ç›´è¿‘ç´„å®šã‚’æ¢ç´¢ä¸­â€¦`;

    // æ®µéšçš„ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ‹¡å¤§ï¼ˆãƒ‡ãƒ¼ã‚¿è–„ã„æ™‚é–“å¸¯å¯¾å¿œï¼‰
    for(const _ of [1,2,3]){
      const start = targetUtcMs - windowSec*1000;
      const end   = targetUtcMs + windowSec*1000;
      try{
        // ã“ã“ã‹ã‚‰ä¿®æ­£ï¼šUSD ã¨ JPY ã‚’åŒä¸€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ä¸¡å–ã‚Š
        [tradesUsd, tradesJpy] = await Promise.all([
          fetchAggTrades('BTCUSDT', start, end, 1000),
          fetchAggTrades('BTCJPY',  start, end, 1000)
        ]);
        // ã“ã“ã¾ã§ä¿®æ­£
      }catch(err){
        note.textContent = `ã‚¨ãƒ©ãƒ¼: ${err.message}`;
        return;
      }
      if(tradesUsd.length || tradesJpy.length) break;
      windowSec *= 4;
    }

    if(!tradesUsd.length){
      head.textContent = 'ãã®è¿‘è¾ºã®ç´„å®šï¼ˆBTCUSDTï¼‰ãŒç„¡ã‹ã£ãŸã§';
      main.textContent = '-';
      ctx.textContent  = '-';
      return;
    }

    const cUsd = findClosest(tradesUsd, targetUtcMs);
    const bestUsd = cUsd.best;

    // ã“ã“ã‹ã‚‰è¿½åŠ ï¼šBTCJPY ã‚‚æœ€è¿‘å‚ã‚’å–ã‚Šã€USD/JPY ã‚’é€†ç®—
    if(!tradesJpy.length){
      note.textContent = 'BTCJPYãŒå–ã‚Œã‚“ã‹ã£ãŸã‹ã‚‰USD/JPYé€†ç®—ã¯ã‚¹ã‚­ãƒƒãƒ—';
    }
    let usdjpyText = '';
    let usdjpy = null;
    if(tradesJpy.length){
      const cJpy = findClosest(tradesJpy, targetUtcMs);
      const bestJpy = cJpy.best;
      // price ã¯æ–‡å­—åˆ—ã®ã“ã¨ãŒã‚ã‚‹ã®ã§æ•°å€¤åŒ–
      const pUsd = parseFloat(bestUsd.p);
      const pJpy = parseFloat(bestJpy.p);
      if(pUsd > 0){
        usdjpy = pJpy / pUsd;
        usdjpyText = `ï¼ˆUSD/JPYâ‰ˆ ${fmtNum(usdjpy,2)} = BTCJPY/BTCUSDTï¼‰`;
        // å…¥åŠ›æ¬„ã¸è‡ªå‹•åæ˜ 
        document.getElementById('priceUsd').value = pUsd.toFixed(2);
        document.getElementById('usdJpy').value  = usdjpy.toFixed(2);
      }
      // æ–‡è„ˆï¼šç›´å‰ç›´å¾Œã‚‚JPYå´ã‚’è¦‹ã›ã‚‹
      ctx.textContent  = `USD ç›´å‰: ${cUsd.before? fmtJSTms(cUsd.before.T)+' @ '+fmtNum(cUsd.before.p,2): 'ãªã—'} ï¼ ç›´å¾Œ: ${cUsd.after? fmtJSTms(cUsd.after.T)+' @ '+fmtNum(cUsd.after.p,2): 'ãªã—'}
  ï½œ JPY ç›´å‰: ${cJpy.before? fmtJSTms(cJpy.before.T)+' @ '+fmtNum(cJpy.before.p,0): 'ãªã—'} ï¼ ç›´å¾Œ: ${cJpy.after? fmtJSTms(cJpy.after.T)+' @ '+fmtNum(cJpy.after.p,0): 'ãªã—'}`;
    } else {
      // æ—¢å­˜USDå´ã®æ–‡è„ˆã ã‘
      ctx.textContent  = `ç›´å‰: ${cUsd.before? fmtJSTms(cUsd.before.T)+' @ '+fmtNum(cUsd.before.p,2): 'ãªã—'} ï¼ ç›´å¾Œ: ${cUsd.after? fmtJSTms(cUsd.after.T)+' @ '+fmtNum(cUsd.after.p,2): 'ãªã—'}`;
    }
    // ã“ã“ã¾ã§è¿½åŠ 

    head.textContent = `JST ${dtStr.replace('T',' ')} ã®ç›´è¿‘ï¼ˆå·® ${Math.round(cUsd.diffMs)} msï¼‰`;
    main.textContent = `ä¾¡æ ¼(USD): ${fmtNum(bestUsd.p, 2)}   é‡(BTC): ${bestUsd.q}   ç´„å®šæ™‚åˆ»(JST): ${fmtJSTms(bestUsd.T)} ${usdjpyText}`;
    note.textContent = 'Binance aggTradesï¼ˆBTCUSDT & BTCJPYï¼‰ã§é€†ç®—';
  }

  (function init(){
    const now = new Date();
    const j = new Date(now.getTime() + 9*3600*1000);
    const s = `${j.getUTCFullYear()}-${pad2(j.getUTCMonth()+1)}-${pad2(j.getUTCDate())}T${pad2(j.getUTCHours())}:${pad2(j.getUTCMinutes())}:${pad2(j.getUTCSeconds())}`;
    document.getElementById('dt').value = s;
    document.getElementById('go').addEventListener('click', run);

    // ã“ã“ã‹ã‚‰è¿½åŠ ï¼šè³¼å…¥è¨˜éŒ²ãƒœã‚¿ãƒ³å‡¦ç†ï¼ˆå††æ›ç®—ã¯é€†ç®—ãƒ¬ãƒ¼ãƒˆã§ï¼‰
    document.getElementById('addRecord').addEventListener('click', ()=>{
      const dt = document.getElementById('dt').value.replace('T',' ');
      const priceUsd = parseFloat(document.getElementById('priceUsd').value);
      const usdJpy   = parseFloat(document.getElementById('usdJpy').value);
      const amount   = parseFloat(document.getElementById('amountBtc').value);
      if(isNaN(priceUsd)||isNaN(usdJpy)||isNaN(amount)) return alert("ä¾¡æ ¼ãƒ»ãƒ¬ãƒ¼ãƒˆãƒ»æ•°é‡ã‚’å…¨éƒ¨å…¥ã‚Œã¦ãª");

      const priceJpy = priceUsd * usdJpy;
      const totalJpy = priceJpy * amount;

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dt}</td><td>${fmtNum(priceUsd,2)}</td><td>${fmtNum(priceJpy,2)}</td><td>${amount}</td><td>${fmtNum(totalJpy,0)}</td>`;
      document.querySelector('#recordsTable tbody').appendChild(tr);
    });
    // ã“ã“ã¾ã§è¿½åŠ 
  })();
</script>
  <footer style="margin-top:2em; padding-top:1em; border-top:1px solid #ccc; font-size:0.9em; color:#666;">
    <p>
      <a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
    </p>
    <p>
      Data: Binance REST API<br>
      Developed by yuichi-code
    </p>
  </footer>
</body>
</html>
